{% extends 'core/base.html' %}
{% load static%}
{% block content %}

  <!--Inner Header Start-->
<section class="wf100 p100 inner-header"
         style="background-image: url({% if page and page.header and page.header.background %}{{ page.header.background.url }}{% else %}{% static 'images/innerheader.jpg' %}{% endif %});
                background-size: cover; background-position: center;">
  <div class="container">
    <h1>{{ page.header.title|default:"Blog" }}</h1>
    <ul>
      <li><a href="{% url 'home' %}">Inicio</a></li>
      <li><a href="{% url 'blog_list' %}">{{ page.header.breadcrumb_label|default:"Blog" }}</a></li>
      {# En la vista de detalle puedes mostrar el título del post como último breadcrumb (sin enlace) #}
      {% if post %}<li>{{ post.titulo }}</li>{% endif %}
    </ul>
  </div>
</section>
 <!--Inner Header End-->

  <!--Blog Start-->
  {% load static %}

<section class="wf100 p80 blog">
  <div class="container">
    <div class="row">

      <!-- Columna principal -->
      <div class="col-md-9">
        <div class="blog-posts">

          {# Soporta posts o page_obj.object_list (paginación) #}
          {% with lista=page_obj.object_list|default:posts %}
          {% for post in lista %}
          <div class="blog-post {% if post.tipo == 'link' %}blog-link{% endif %}">

            {# THUMB / MEDIA SEGÚN TIPO #}
            {% if post.tipo == "standard" or post.tipo == "link" %}
              {% if post.header_image %}
              <div class="blog-thumb">
                <a href="{% url 'blog_detail' slug=post.slug %}"><i class="fas fa-link"></i></a>
                <img src="{{ post.header_image.url }}" alt="{{ post.titulo }}">
              </div>
              {% endif %}
            {% elif post.tipo == "gallery" %}
  <div class="blog-slider">
    <div id="bslider-{{ post.id }}" class="owl-carousel owl-theme">
      {% for foto in post.fotos.all %}
        {% if foto.publicado %}
        <div class="item">
          <img src="{{ foto.imagen.url }}" alt="{{ foto.alt|default:foto.titulo|default:post.titulo }}">
          {% if foto.titulo %}
            <div class="blog-photo-title">{{ foto.titulo }}</div>
          {% endif %}
        </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
            {% elif post.tipo == "video" %}
              <div class="blog-video">
                <iframe src="{{ post.video_url }}" allowfullscreen></iframe>
              </div>
            {% elif post.tipo == "audio" %}
              <div class="blog-audio">
                <iframe src="{{ post.audio_url }}"></iframe>
              </div>
            {% endif %}

            <div class="blog-txt">
              {% if post.tipo == "link" and post.enlace_externo %}
                <h4><a href="{{ post.enlace_externo }}" target="_blank" rel="noopener">{{ post.titulo }}</a></h4>
              {% else %}
                <h3><a href="{% url 'blog_detail' slug=post.slug %}">{{ post.titulo }}</a></h3>
              {% endif %}

              <ul class="post-meta">
                {% if post.autor %}
                  <li><a href="{% url 'blog_by_author' slug=post.autor.slug %}">
                    <i class="fas fa-user-circle"></i> {{ post.autor.nombre }}</a>
                  </li>
                {% endif %}
                <li><a href="#"><i class="fas fa-calendar-alt"></i> {{ post.fecha_publicacion|date:"d M, Y" }}</a></li>
                <li><a href="{% url 'blog_detail' slug=post.slug %}#comments">
                  <i class="fas fa-comments"></i> {{ post.comentarios_count }} Comentarios</a>
                </li>
                {% if post.tags.all %}
                  <li class="post-tags"><i class="fas fa-tags"></i>
                    {% for t in post.tags.all %}
                      <a href="{% url 'blog_by_tag' slug=t.slug %}">{{ t.nombre }}</a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                  </li>
                {% endif %}
              </ul>

              <p>{{ post.resumen|default:post.cuerpo_html|striptags|truncatechars:260 }}</p>
              {% if post.tipo != "link" %}
                <a href="{% url 'blog_detail' slug=post.slug %}" class="read-post">Leer post</a>
              {% endif %}
            </div>
          </div>
          {% empty %}
            <p>No hay publicaciones aún.</p>
          {% endfor %}
          {% endwith %}

          {# Paginación (opcional) #}
          {% if page_obj %}
          <div class="gt-pagination">
            <nav>
              <ul class="pagination">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}" aria-label="Previous">
                      <i class="fas fa-angle-left"></i>
                    </a>
                  </li>
                {% endif %}
                {% for num in page_obj.paginator.page_range %}
                  {% if num == page_obj.number %}
                    <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                  {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}{% if q %}&q={{ q|urlencode }}{% endif %}">{{ num }}</a></li>
                  {% endif %}
                {% endfor %}
                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}" aria-label="Next">
                      <i class="fas fa-angle-right"></i>
                    </a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Sidebar -->
      <div class="col-md-3">
        <div class="sidebar">
          {% for w in widgets %}
            <div class="side-widget {% if w.tipo == 'text' %}text-widget{% endif %}">
              {% if w.titulo %}<h5>{{ w.titulo }}</h5>{% endif %}

              {% if w.tipo == "search" %}
              <!-- Buscador -->
                <div class="side-search">
                  <form method="get" action="{% url 'blog_list' %}">
                    <input type="search" name="q" class="form-control" placeholder="Buscar" value="{{ q }}">
                    <button><i class="fas fa-search"></i></button>
                  </form>
                </div>

              {% elif w.tipo == "text" %}
                <p>{{ w.body_html|safe }}</p>

              {% elif w.tipo == "latest_posts" %}
              {% if w.body_html %}<p>{{ w.body_html|safe }}</p>{% endif %}
              <ul class="lastest-products">
                {% for p in latest_posts %}
                  {# mostramos solo los primeros w.limite #}
                  {% if forloop.counter0 < w.limite %}
                    <li>
                      {% if p.header_image %}
                        <img src="{{ p.header_image.url }}" alt="{{ p.titulo }}"
                 style="width:64px;height:64px;object-fit:cover;border-radius:6px;">
                      {% endif %}
                      <strong>
                      {% if p.slug %}
                        <a href="{% url 'blog_detail' slug=p.slug %}">{{ p.titulo }}</a>
                      {% else %}
                        <span class="text-muted">Sin enlace</span>
                      {% endif %}
                    </strong>

                      <span class="pdate"><i class="fas fa-calendar-alt"></i> {{ p.fecha_publicacion|date:"d M, Y" }}</span>
                    </li>
                  {% endif %}
                {% empty %}
                  <li class="text-muted">No hay publicaciones recientes.</li>
                {% endfor %}
              </ul>

              {% elif w.tipo == "projects" or w.tipo == "recent_work" %}
                <div id="side-slider-{{ w.id }}" class="owl-carousel owl-theme">
                  {% for p in w.proyectos.all %}
                  <div class="item">
                    <div class="pro-box">
                      {% if p.header_image %}<img src="{{ p.header_image.url }}" alt="{{ p.titulo }}">{% endif %}
                      <h5>{{ p.titulo }}</h5>
                      <div class="pro-hover">
                        <h6>{{ p.titulo }}</h6>
                        <p>{{ p.resumen|default:p.body_html|striptags|truncatechars:120 }}</p>
                        {% if p.url %}<a href="{{ p.url }}" target="_blank" rel="noopener">Ver más</a>{% endif %}
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>

              {% elif w.tipo == "tags" %}
                <div class="single-post-tags">
                  {% for t in all_tags %}
                    <a href="{% url 'blog_by_tag' slug=t.slug %}">{{ t.nombre }}</a>
                  {% endfor %}
                </div>

              {% elif w.tipo == "archives" %}
                <ul>
                  <div class="side-widget archives">
                  {% for d in archives %}

                    <li><a href="{% url 'blog_by_month' year=d|date:'Y' month=d|date:'n' %}" >{{ d|date:"F Y" }}</a></li>
                  {% endfor %}
                  </div>
                </ul>

              {% elif w.tipo == "cta_volunteer" %}
                <h5><a href="{{ w.link_url|default:page.volunteer_url }}"> {{ w.link_label|default:'Súmate' }} </a></h5>

              {% elif w.tipo == "cta_donate" %}
                <div class="donation-amount">
                  <h5><a href="{{ w.link_url|default:page.donate_url }}"> {{ w.link_label|default:'Dona' }} </a></h5>
                </div>

              {% elif w.tipo == "custom_html" %}
                {{ w.body_html|safe }}

              {% endif %}
            </div>
          {% empty %}
          <p class="text-muted">Sin widgets configurados.</p>
          {% endfor %}
        </div>
      </div>

    </div>
  </div>
</section>

  <!--Blog End--> 

{% endblock %}